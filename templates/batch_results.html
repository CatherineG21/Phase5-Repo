{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        {% if error %}
        <!-- Error Display -->
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Batch Processing Error</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <h5><i class="bi bi-x-circle"></i> Error occurred during batch processing:</h5>
                    <p class="mb-0">{{ error }}</p>
                </div>
                <div class="text-center">
                    <a href="/batch" class="btn btn-primary">
                        <i class="bi bi-arrow-left"></i> Try Again
                    </a>
                </div>
            </div>
        </div>
        
        {% else %}
        <!-- Results Display -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-clipboard-data"></i> Batch Analysis Results</h4>
                <p class="mb-0">{{ total_count }} firms processed | {{ high_risk_count }} high-risk firms identified</p>
            </div>
            <div class="card-body">
                
                <!-- Summary Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <h1 class="text-primary">{{ total_count }}</h1>
                                <p class="mb-0">Total Firms</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <h1 class="text-danger">{{ high_risk_count }}</h1>
                                <p class="mb-0">High-Risk Firms</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h1 class="text-success">{{ total_count - high_risk_count }}</h1>
                                <p class="mb-0">Low-Risk Firms</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h1 class="text-warning">
                                    {% if total_count > 0 %}
                                    {{ ((high_risk_count / total_count) * 100)|round(1) }}%
                                    {% else %}
                                    0%
                                    {% endif %}
                                </h1>
                                <p class="mb-0">High-Risk Rate</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Table -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Risk Level</th>
                                <th>Probability</th>
                                <th>Audit Flag</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prediction in predictions %}
                            <tr class="{% if 'error' in prediction %}table-warning{% elif prediction.is_high_risk %}table-danger{% else %}table-success{% endif %}">
                                <td>{{ prediction.id }}</td>
                                <td>
                                    {% if 'error' in prediction %}
                                        <span class="badge bg-warning">ERROR</span>
                                    {% else %}
                                        <span class="badge bg-{{ 
                                            'danger' if prediction.risk_level == 'CRITICAL' 
                                            else 'warning' if prediction.risk_level == 'HIGH' 
                                            else 'info' if prediction.risk_level == 'MEDIUM' 
                                            else 'success' 
                                        }}">
                                            {{ prediction.risk_level }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if 'error' in prediction %}
                                        <span class="text-muted">N/A</span>
                                    {% else %}
                                        {{ prediction.probability }}%
                                    {% endif %}
                                </td>
                                <td>
                                    {% if 'error' in prediction %}
                                        <span class="text-muted">-</span>
                                    {% elif prediction.is_high_risk %}
                                        <span class="badge bg-danger">FLAG</span>
                                    {% else %}
                                        <span class="badge bg-success">CLEAR</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if 'error' in prediction %}
                                        <small class="text-danger">{{ prediction.error }}</small>
                                    {% elif prediction.is_high_risk %}
                                        <small>Audit Recommended</small>
                                    {% else %}
                                        <small>No Action Required</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <div class="btn-group" role="group">
                        <a href="/batch" class="btn btn-primary">
                            <i class="bi bi-upload"></i> New Batch
                        </a>
                        <button class="btn btn-success" onclick="downloadResults()">
                            <i class="bi bi-download"></i> Download Results
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="bi bi-house"></i> Home
                        </a>
                        {% if high_risk_count > 0 %}
                        <button class="btn btn-danger" onclick="alert('Audit list generated with {{ high_risk_count }} high-risk firms. Case ID: BATCH-' + Date.now())">
                            <i class="bi bi-clipboard-check"></i> Generate Audit List
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Risk Distribution -->
                <div class="mt-5">
                    <h6><i class="bi bi-pie-chart"></i> Risk Distribution:</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="progress" style="height: 30px;">
                                {% set critical_count = predictions|selectattr('risk_level', 'equalto', 'CRITICAL')|list|length %}
                                {% set high_count = predictions|selectattr('risk_level', 'equalto', 'HIGH')|list|length %}
                                {% set medium_count = predictions|selectattr('risk_level', 'equalto', 'MEDIUM')|list|length %}
                                {% set low_count = predictions|selectattr('risk_level', 'equalto', 'LOW')|list|length %}
                                
                                {% if total_count > 0 %}
                                <div class="progress-bar bg-danger" style="width: {{ (critical_count / total_count) * 100 }}%">
                                    CRITICAL: {{ critical_count }}
                                </div>
                                <div class="progress-bar bg-warning" style="width: {{ (high_count / total_count) * 100 }}%">
                                    HIGH: {{ high_count }}
                                </div>
                                <div class="progress-bar bg-info" style="width: {{ (medium_count / total_count) * 100 }}%">
                                    MEDIUM: {{ medium_count }}
                                </div>
                                <div class="progress-bar bg-success" style="width: {{ (low_count / total_count) * 100 }}%">
                                    LOW: {{ low_count }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function downloadResults() {
    // Create CSV content from results
    let csvContent = "ID,Risk Level,Probability,Audit Flag,Status\n";
    
    {% for prediction in predictions %}
    csvContent += "{{ prediction.id }},{{ prediction.risk_level if 'error' not in prediction else 'ERROR' }},{{ prediction.probability if 'error' not in prediction else 'N/A' }}%,{{ 'FLAG' if prediction.is_high_risk else 'CLEAR' if 'error' not in prediction else '-' }},{{ prediction.error if 'error' in prediction else ('Audit Recommended' if prediction.is_high_risk else 'No Action Required') }}\n";
    {% endfor %}
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cit_batch_results_{{ total_count }}_firms.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
