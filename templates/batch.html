{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-upload"></i> Batch Firm Analysis</h4>
                <p class="mb-0 text-white-50">Upload CSV file with multiple firms for bulk risk assessment</p>
            </div>
            <div class="card-body">
                <form method="POST" action="/batch" enctype="multipart/form-data">
                    <div class="mb-4">
                        <h5>Upload CSV File</h5>
                        <input type="file" class="form-control" name="file" accept=".csv" required>
                        <div class="form-text">
                            File must be CSV format with required columns. 
                            <a href="#" data-bs-toggle="modal" data-bs-target="#templateModal">
                                Download template
                            </a>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5>Required Columns</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ul>
                                    <li><code>cost_to_turnover</code></li>
                                    <li><code>admin_cost_ratio</code></li>
                                    <li><code>employment_cost_ratio</code></li>
                                    <li><code>financing_cost_ratio</code></li>
                                    <li><code>deductions_to_turnover</code></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul>
                                    <li><code>high_cost_flag</code> (0 or 1)</li>
                                    <li><code>thin_margin_flag</code> (0 or 1)</li>
                                    <li><code>turnover_bin_q</code> (Q1, Q2, Q3, Q4)</li>
                                    <li><code>sector</code></li>
                                    <li><code>grossturnover</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Processing Information</h6>
                        <ul class="mb-0">
                            <li>Maximum file size: 10MB</li>
                            <li>Maximum rows: 10,000</li>
                            <li>Processing time: ~10ms per firm</li>
                            <li>Results can be downloaded as CSV</li>
                        </ul>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="bi bi-play-circle"></i> Start Batch Analysis
                        </button>
                        <a href="/" class="btn btn-outline-secondary btn-lg ms-2">
                            <i class="bi bi-house"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Sample Data Info -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-spreadsheet"></i> CSV Format Example</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>cost_to_turnover</th>
                                <th>admin_cost_ratio</th>
                                <th>employment_cost_ratio</th>
                                <th>financing_cost_ratio</th>
                                <th>deductions_to_turnover</th>
                                <th>high_cost_flag</th>
                                <th>thin_margin_flag</th>
                                <th>turnover_bin_q</th>
                                <th>sector</th>
                                <th>grossturnover</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>0.85</td>
                                <td>0.15</td>
                                <td>0.10</td>
                                <td>0.05</td>
                                <td>0.03</td>
                                <td>1</td>
                                <td>0</td>
                                <td>Q3</td>
                                <td>CONSTRUCTION</td>
                                <td>10000000</td>
                            </tr>
                            <tr>
                                <td>0.45</td>
                                <td>0.08</td>
                                <td>0.05</td>
                                <td>0.02</td>
                                <td>0.01</td>
                                <td>0</td>
                                <td>0</td>
                                <td>Q4</td>
                                <td>FINANCIAL AND INSURANCE ACTIVITIES</td>
                                <td>50000000</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Download CSV Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>The template includes all required columns with sample data.</p>
                <a href="#" class="btn btn-primary" onclick="downloadTemplate()">
                    <i class="bi bi-download"></i> Download Template
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function downloadTemplate() {
    // Create sample CSV content
    const csvContent = "cost_to_turnover,admin_cost_ratio,employment_cost_ratio,financing_cost_ratio,deductions_to_turnover,high_cost_flag,thin_margin_flag,turnover_bin_q,sector,grossturnover\n" +
                      "0.85,0.15,0.10,0.05,0.03,1,0,Q3,CONSTRUCTION,10000000\n" +
                      "0.45,0.08,0.05,0.02,0.01,0,0,Q4,FINANCIAL AND INSURANCE ACTIVITIES,50000000\n" +
                      "0.67,0.13,0.08,0.03,0.04,1,1,Q2,WHOLESALE AND RETAIL TRADE, REPAIR OF MOTOR VEHICLES AND MOTORCYCLES,25000000";
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cit_risk_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Close modal
    var modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
    modal.hide();
}
</script>
{% endblock %}
